# DBOpt_Course_PaymentData
Задание к курсу Оптимизация баз данных - расчёт балансов

## Порядок выполнения и взаимодействия
1. Все вопросы оформлять в виде Issue
2. Все изменения и результаты оформлять в виде Pull Request из собственного fork

## Требования к окружению
MS SQL Server любой версии (предпочтительно 2016 и старше).
Допустимо использование иной СУБД при портировании исходного скрипта с учётом конечного диалекта SQL.
## Начальные действия
1. Ознакомиться с документом, описывающим формулы расчёта баланса и примером его изменения
2. Ознакомиться со скриптом создания базы данных
3. Ознакомиться с программными компонентами (функции, триггера)
4. Разработать и применить генератор тестовых данных
5. Разработать простой тест на корректность расчёта баланса

Ожидаемый результат - доступная для оптимизации БД с тестовыми данными

## Задачи I уровня
1. Реализовать индексы, повышающие производительность операций вставки и изменения платежей без модификации программных компонент.

* Решение: были созданы индексы, для непроиндексированных полей в запросе изменения платежей. В рамках задачи удалялись и вставлялись 10 000 записей. До предложенной индексации время выполнения - 1m20s . После - 58s.

## Задачи II уровня
В исходной версии балансы обновляются в рамках транзакции целевого действия над платежом - создания или изменения. Предположим, что требования к производительности не выполняются при такой реализации.

Введём две роли пользователей: бухгалтер-оператор и бухгалтер-аналитик.

**Оператор** - занимается вводом и корректировкой платежей, не имеет доступа к данным о балансах.

**Бухгалтер-аналитик** - отслеживает балансы и заведённые платежи для принятия решения о предпринимаемых финансовых действиях (какие счета использовать, какие образовались долги и т.д.).

1. Дать оценку затрат на выполнения операций расчёта балансов в рамках транзакций создания и изменения платежа. Желательно представить количественную оценку, но допустимо и относительную (к примеру, "90% ресурсов и времени уходит на расчёт баланса"). Чем детальнее, тем лучше.

<i>Оценка, с помощью плана выполнения, взятого из Activity Monitor.</i>

# Таблица Payment:
* В рамках исследования выявлено, что при добавлении данных 82% ресурсов идет на добавление кластерного индекса. Остальные ресурсы, отличные от 0, в среднем 4%.
<i>PlanOfPaimentInsert</i>

# Таблица PaymentParticipant:
* В рамках исследования выявлено, что при добавлении данных 100% ресурсов идет на добавление кластерного индекса.
<i>PlanOfPaymentParticipantInsert</i>

# Таблица Project:
* В рамках исследования выявлено, что при добавлении данных 84% ресурсов идет на добавление кластерного индекса. Остальные ресурсы, отличные от 0, в среднем 5%.
<i>PlanOfProjectInsert</i>

# CalculateBalanceByMaterial
* Самые затратные операции - добавления кластерного индекса (46%, 46%).

# CalculateBalanceParticipantBalance
* Самые затратные операции - добавления кластерного индекса (46%, 47%).


2. Предложить сценарий оптимизации механизмов расчёта. Сценарий должен допускать максимизацию скорости целевых изменений и допускать отложенное вычисление балансов (балансы и данные платежей должны быть согласованы в конечном счёте).

<i>Очевидно, что для бугалтера-оператора нет нобходимости пересчитывать баланс, поэтому можно "накомпить" его данные и при работе аналитика посчитать введенные данные.</i>

## Способы реализации предложенной методики:
* Реализовать разные версии клиентов, при которых у аналитика и оператора будут выполняться разные запросы к бд - соответственно у аналита сразу с подсчетом баланса, у оператора без.

* Создать дополнительную таблицу, которую можно использовать как "буфер". Например при накоплении n-ого количества введенных оператором транзакций, сработает триггер, пересчитывающий балансы.
   
3. Оценить недостатки предлагаемого сценария с точки зрения потенциальных пользователей.

1. Реализация "похожих" запросов или реализация нескольких клиентов. Если пересчитывать балансы во время начала работы аналитика - можно потерять достаточно много времени.



## Задачи III уровня
1. Реализовать предложенный сценарий отложенного вычисления.
2. Дать оценку затрат на выполнение операций расчёта балансов в рамках транзакций создания и изменения платежа. Дать заключение о полученном росте производительности, если таковое будет наблюдаться.
3. Дать оценку возникшим проблемам и недостаткам, сравнить их с оценками, сделанными при проектировании сценария оптимизации (указать, что сбылось, что неожиданно проявилось и т.д.).
4. Дать заключение о преимуществах и недостатках выполненной оптимизации (превосходят ли полученные преимущества те недостатки, которые возникли после оптимизации).


# Links
* [Generator data exaples](https://www.devart.com/dbforge/sql/data-generator/)
